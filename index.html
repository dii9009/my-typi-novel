<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cloud Studio v5.58 Final</title>
    <style>
        :root { --font-size: 1.15rem; --paragraph-margin: 10px; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: #1a1a1a; color: #d4d4d4; font-family: 'Pretendard', -apple-system, sans-serif; overflow: hidden; }
        .app-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; position: relative; }
        
        /* ì ê¸ˆ í™”ë©´ */
        #lock-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #111; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #lock-screen input { padding: 15px; width: 220px; border-radius: 8px; border: 1px solid #333; background: #222; color: white; font-size: 1.2rem; text-align: center; outline: none; }
        #lock-screen button { margin-top: 15px; padding: 10px 40px; background: #4a90e2; border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 280px; min-width: 280px; height: 100%; background: #111; border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; box-sizing: border-box; z-index: 1000; }
        @media (max-width: 768px) { .sidebar { position: fixed; left: 0; transform: translateX(-100%); transition: 0.3s; } .sidebar.active { transform: translateX(0); } }
        
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .sidebar-header h2 { font-size: 0.75rem; color: #444; letter-spacing: 2px; margin: 0; cursor: pointer; }
        .refresh-btn { cursor: pointer; color: #4a90e2; font-size: 1.2rem; padding: 5px; }

        .tab-menu { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 8px; font-size: 0.7rem; background: none; border: 1px solid #333; color: #555; cursor: pointer; border-radius: 4px; }
        .tab-btn.active { background: #2a2a2a; color: #fff; border-color: #4a90e2; }

        .sidebar-content { flex: 1; overflow-y: auto; }
        .hidden { display: none !important; }

        /* ì—í”¼ì†Œë“œ ë¦¬ìŠ¤íŠ¸ ë° ë“œë˜ê·¸ */
        .folder-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 8px; cursor: pointer; color: #bbb; font-weight: bold; font-size: 0.85rem; border-bottom: 1px solid #222; }
        .chapter-list { list-style: none; padding-left: 10px; margin: 5px 0; min-height: 50px; }
        .chapter-item-container { display: flex; justify-content: space-between; align-items: center; border-radius: 4px; margin-bottom: 2px; cursor: grab; background: #1a1a1a; transition: background 0.1s; }
        .chapter-item-container.dragging { opacity: 0.4; background: #333; border: 1px dashed #4a90e2; }
        .chapter-item-container.active { background: #222 !important; border-left: 3px solid #4a90e2; }
        .chapter-item { flex: 1; padding: 12px 10px; font-size: 0.85rem; color: #777; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; pointer-events: none; }

        /* ë©”ì¸ ì—ë””í„° */
        .main-content { flex: 1; height: 100%; overflow-y: auto; display: flex; flex-direction: column; align-items: center; padding: 40px 20px 160px 20px; box-sizing: border-box; background: #1a1a1a; position: relative; }
        .editor-container { width: 100%; max-width: 800px; }
        #chapter-title { width: 100%; font-size: 1.8rem; border: none; background: transparent; color: #fff; outline: none; margin-bottom: 30px; font-weight: bold; }
        #editor { width: 100%; min-height: 70vh; font-size: var(--font-size); line-height: 1.8em; color: #d4d4d4; outline: none; white-space: pre-wrap; word-break: break-all; }

        /* AI íŒì—… ë° íŒ¨ë„ */
        #ai-popup-btn { position: absolute; display: none; background: #4a90e2; color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; cursor: pointer; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #right-panel { position: absolute; top: 0; right: 0; width: 350px; height: 100%; background: #111; border-left: 1px solid #333; z-index: 1500; display: flex; flex-direction: column; transform: translateX(100%); transition: 0.3s; padding: 20px; box-sizing: border-box; }
        #right-panel.active { transform: translateX(0); }
        
        .panel-tab { display: flex; gap: 10px; border-bottom: 1px solid #222; padding-bottom: 10px; margin-bottom: 15px; }
        .panel-tab button { background: none; border: none; color: #555; cursor: pointer; font-size: 0.75rem; }
        .panel-tab button.active { color: #4a90e2; font-weight: bold; }

        .model-switch-container { display: flex; background: #222; border-radius: 6px; padding: 3px; margin-bottom: 15px; }
        .model-switch-btn { flex: 1; padding: 6px; border: none; background: none; color: #555; font-size: 0.65rem; cursor: pointer; border-radius: 4px; }
        .model-switch-btn.active { background: #333; color: #4a90e2; font-weight: bold; }

        .search-res-item { padding: 15px 10px; border-bottom: 1px solid #222; cursor: pointer; }
        .highlight { color: #fff; background: rgba(74, 144, 226, 0.4); font-weight: bold; padding: 0 2px; }

        .status-bar { position: fixed; bottom: 0; left: 280px; right: 0; background: #111; border-top: 1px solid #222; z-index: 998; }
        @media (max-width: 768px) { .status-bar { left: 0; } }
        .status-info { padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h2 style="color:#4a90e2; letter-spacing:4px;">STUDIO LOCK</h2>
        <input type="password" id="pw-input" placeholder="Password" onkeypress="if(event.keyCode==13) checkAuth()">
        <button onclick="checkAuth()">ENTER</button>
    </div>

    <button id="ai-popup-btn" onclick="callAIFromSelection()">ğŸ¤– AI ë„ì›€</button>

    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 onclick="location.reload()">CLOUD STUDIO</h2>
                <span onclick="location.reload()" style="cursor:pointer; color:#4a90e2;">â†»</span>
            </div>
            <div class="tab-menu">
                <button class="tab-btn active" id="tab-epi" onclick="switchTab('epi')">ğŸ“ ì—í”¼ì†Œë“œ</button>
                <button class="tab-btn" id="tab-world" onclick="switchTab('world')">ğŸŒ ì„¤ì •/ë©”ëª¨</button>
            </div>
            <div id="content-epi" class="sidebar-content">
                <div style="display:flex; gap:8px; margin-bottom:20px;">
                    <button onclick="addNewFolder()" style="flex:1; padding:10px; background:#2a2a2a; border:1px solid #444; color:#fff; border-radius:6px; font-size:0.75rem;">ğŸ“ í´ë”</button>
                    <button onclick="addNewChapter()" style="flex:1; padding:10px; background:#2a2a2a; border:1px solid #444; color:#fff; border-radius:6px; font-size:0.75rem;">ğŸ“ ì—í”¼</button>
                </div>
                <div id="folder-list">ë°ì´í„° ì—°ë™ ì¤‘...</div>
            </div>
            <div id="content-world" class="sidebar-content hidden">
                <textarea id="world-memo-area" style="width:100%; height:85%; background:transparent; border:none; color:#888; font-size:0.85rem; outline:none; resize:none;" placeholder="ì„¸ê³„ê´€ ì„¤ì •ì„ ê¸°ë¡í•˜ì„¸ìš”..."></textarea>
            </div>
        </div>

        <div class="main-content" onmouseup="handleSelection()" onclick="closePanels()">
            <div class="editor-container">
                <div style="display:flex; gap:8px; margin-bottom:20px; justify-content:flex-end;">
                    <button onclick="event.stopPropagation(); openSearch();" style="background:#222; border:1px solid #4a90e2; color:#4a90e2; padding:6px 12px; border-radius:4px; font-size:0.75rem; cursor:pointer; font-weight:bold;">ğŸ” ê²€ìƒ‰/AI</button>
                    <button onclick="copyAllText()" style="background:none; border:1px solid #333; color:#aaa; padding:6px 12px; border-radius:4px; font-size:0.75rem; cursor:pointer;">ğŸ“‹ ë³µì‚¬</button>
                    <button onclick="restoreVersion()" style="background:none; border:1px solid #333; color:#888; padding:6px 12px; border-radius:4px; font-size:0.75rem; cursor:pointer;">â³ ë³µêµ¬</button>
                    <button onclick="exportText()" style="background:none; border:1px solid #333; color:#888; padding:6px 12px; border-radius:4px; font-size:0.75rem; cursor:pointer;">ğŸ’¾ TXT</button>
                </div>
                <input type="text" id="chapter-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                <div id="editor" contenteditable="true" spellcheck="true"></div>
            </div>
        </div>

        <div id="right-panel">
            <div class="panel-tab">
                <button id="p-tab-search" class="active" onclick="switchPanelTab('search')">ğŸ” ê²€ìƒ‰</button>
                <button id="p-tab-ai" onclick="switchPanelTab('ai')">ğŸ¤– AI ì¡°ì–¸</button>
                <span onclick="closePanels()" style="cursor:pointer; margin-left:auto; color:#555;">&times;</span>
            </div>
            <div id="p-content-search" style="flex:1; overflow-y:auto;">
                <div id="search-results-list"></div>
            </div>
            <div id="p-content-ai" class="hidden" style="flex:1; overflow-y:auto;">
                <div class="model-switch-container">
                    <button id="model-flash" class="model-switch-btn active" onclick="switchModel('flash')">Flash (ë¹ ë¦„)</button>
                    <button id="model-pro" class="model-switch-btn" onclick="switchModel('pro')">Pro (ë˜‘ë˜‘í•¨)</button>
                </div>
                <div id="ai-results-area"></div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div id="progress-bar" style="height:3px; background:#4a90e2; width:0%; transition:0.3s;"></div>
        <div class="status-info">
            <div>ëª©í‘œ:<span id="display-goal">5,000</span> / <span id="word-count">0ì</span></div>
            <div style="display:flex; align-items:center; gap:5px;">
                <span id="last-save-time" style="color:#444;">ì €ì¥ ëŒ€ê¸°</span>
                <div id="sync-status" style="font-weight:bold; color:#4ade80;">â—</div>
                <span style="color:#222; font-weight:bold; margin-left:10px;">v5.58</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, onSnapshot, query, orderBy, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”¥ Firebase ì„¤ì •
        const firebaseConfig = { 

 apiKey: "AIzaSyC4FjTYr8xxPH9y7H13h8EzIf-CxKb8QkI",
  authDomain: "my-typi-app.firebaseapp.com",
  projectId: "my-typi-app",
  storageBucket: "my-typi-app.firebasestorage.app",
  messagingSenderId: "793573516752",
  appId: "1:793573516752:web:2b3d20a8c432a0b5d445d5"
 };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch(() => {});

        // ğŸ“ Gemini API í‚¤ (ì—¬ê¸°ì— ë³¸ì¸ì˜ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”)
        const GEMINI_API_KEY = gen-lang-client-0388678400 ;

        const syncStatus = document.getElementById('sync-status');
        const editor = document.getElementById('editor');
        const titleInput = document.getElementById('chapter-title');
        const worldMemo = document.getElementById('world-memo-area');
        const rightPanel = document.getElementById('right-panel');
        const aiPopup = document.getElementById('ai-popup-btn');
        const searchList = document.getElementById('search-results-list');
        const aiResults = document.getElementById('ai-results-area');

        let currentChapterId = localStorage.getItem('lastChapterId') || '';
        let currentFolderId = localStorage.getItem('lastFolderId') || 'none';
        let isTyping = false;
        let lastSavedContent = ""; 
        let selectedText = "";
        let currentModel = 'flash';
        let settings = { goalWords: 5000, fontSize: 1.15, studioPw: "0000" };
        let foldersData = [];
        let chaptersData = [];

        // 1. ì¸ì¦ ë° ì´ˆê¸°í™”
        onSnapshot(doc(db, "app_settings", "global_v1"), (sDoc) => {
            if (sDoc.exists()) { settings = { ...settings, ...sDoc.data() }; applySettings(); }
        });

        window.checkAuth = () => {
            if(document.getElementById('pw-input').value === settings.studioPw) {
                document.getElementById('lock-screen').style.display = 'none';
                sessionStorage.setItem('isStudioAuth', 'true');
                startApp();
            } else { alert("ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜"); }
        };
        if(sessionStorage.getItem('isStudioAuth') === 'true') { document.getElementById('lock-screen').style.display = 'none'; startApp(); }

        function applySettings() {
            document.documentElement.style.setProperty('--font-size', settings.fontSize + 'rem');
            document.getElementById('display-goal').innerText = parseInt(settings.goalWords).toLocaleString();
            document.getElementById('display-font').innerText = settings.fontSize;
            updateWordCount();
        }

        // 2. [v5.57 í•µì‹¬] ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì •ë ¬ ë¡œì§
        let dragSrcEl = null;
        function handleDragStart(e) { dragSrcEl = this; this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); return false; }
        async function handleDrop(e) {
            e.stopPropagation();
            if (dragSrcEl !== this) {
                const list = this.parentNode;
                const nodes = Array.from(list.children);
                if (nodes.indexOf(dragSrcEl) < nodes.indexOf(this)) list.insertBefore(dragSrcEl, this.nextSibling);
                else list.insertBefore(dragSrcEl, this);
                const batch = writeBatch(db);
                Array.from(list.children).forEach((item, idx) => { batch.update(doc(db, "myNovels", item.dataset.id), { order: idx }); });
                await batch.commit();
            }
            return false;
        }
        function handleDragEnd() { this.classList.remove('dragging'); }

        // 3. ì•± êµ¬ë™ ë° ë°ì´í„° ë™ê¸°í™”
        function startApp() {
            onSnapshot(query(collection(db, "folders"), orderBy("createdAt", "asc")), (snap) => {
                foldersData = []; snap.forEach(d => foldersData.push({id: d.id, ...d.data()}));
                renderAll();
            });
            onSnapshot(collection(db, "myNovels"), (snap) => {
                syncStatus.style.color = "#4ade80";
                chaptersData = []; snap.forEach(d => chaptersData.push({id: d.id, ...d.data()}));
                chaptersData.sort((a, b) => (a.order || 0) - (b.order || 0) || (a.createdAt || 0) - (b.createdAt || 0));
                renderAll();
                if(!isTyping && currentChapterId) loadChapter(currentChapterId);
            });
        }

        function renderAll() {
            const listUI = document.getElementById('folder-list');
            listUI.innerHTML = '';
            const unclassified = chaptersData.filter(c => !c.folderId);
            if(unclassified.length > 0) listUI.appendChild(renderFolderUI("ë¯¸ë¶„ë¥˜", "none", unclassified));
            foldersData.forEach(f => listUI.appendChild(renderFolderUI(f.name, f.id, chaptersData.filter(c => c.folderId === f.id))));
        }

        function renderFolderUI(name, id, chapters) {
            const div = document.createElement('div');
            const isOpen = (currentFolderId === id);
            div.innerHTML = `<div class="folder-header ${isOpen ? 'open' : ''}" onclick="toggleFolder('${id}')"><span>ğŸ“‚ ${name}</span></div><ul class="chapter-list ${isOpen ? '' : 'hidden'}"></ul>`;
            const ul = div.querySelector('ul');
            chapters.forEach(c => {
                const li = document.createElement('li'); 
                li.className = `chapter-item-container ${c.id === currentChapterId ? 'active' : ''}`;
                li.dataset.id = c.id;
                li.draggable = true;
                li.innerHTML = `<div class="chapter-item">${c.title || 'ì œëª© ì—†ìŒ'}</div><div style="padding:0 10px; opacity:0.3; cursor:pointer;" onclick="deleteChapter('${c.id}', event)">Ã—</div>`;
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragover', handleDragOver);
                li.addEventListener('drop', handleDrop);
                li.addEventListener('dragend', handleDragEnd);
                li.onclick = (e) => { if (e.target.innerText !== 'Ã—') { isTyping = false; loadChapter(c.id); } };
                ul.appendChild(li);
            });
            return div;
        }

        // 4. AI ë° ê²€ìƒ‰ ê¸°ëŠ¥
        window.switchModel = (m) => { currentModel = m; document.getElementById('model-flash').classList.toggle('active', m === 'flash'); document.getElementById('model-pro').classList.toggle('active', m === 'pro'); };
        window.handleSelection = () => {
            const selection = window.getSelection();
            selectedText = selection.toString().trim();
            if (selectedText.length > 2) {
                const rect = selection.getRangeAt(0).getBoundingClientRect();
                aiPopup.style.left = `${rect.left + (rect.width / 2) - 40}px`;
                aiPopup.style.top = `${window.scrollY + rect.top - 45}px`;
                aiPopup.style.display = 'block';
            } else { aiPopup.style.display = 'none'; }
        };

        window.callAIFromSelection = async () => {
            aiPopup.style.display = 'none';
            switchPanelTab('ai');
            rightPanel.classList.add('active');
            aiResults.innerHTML = `<p style="color:#4a90e2; font-size:0.8rem;">ğŸ¤– AIê°€ ë¶„ì„ ì¤‘...</p>`;
            
            const modelName = currentModel === 'flash' ? 'gemini-1.5-flash' : 'gemini-1.5-pro';
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${GEMINI_API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `ë„ˆëŠ” ì†Œì„¤ê°€ ì–´ì‹œìŠ¤í„´íŠ¸ì•¼. í˜„ì¬ ì„¸ê³„ê´€: ${worldMemo.value}\n\në‹¤ìŒ ë¬¸ì¥ì„ ì¥ë¥´ ë¶„ìœ„ê¸°ì— ë§ì¶° ë‹¤ë“¬ì–´ì¤˜: "${selectedText}"` }] }] })
                });
                const data = await response.json();
                const result = data.candidates[0].content.parts[0].text;
                aiResults.innerHTML = `<div style="background:#1a1a1a; padding:15px; border-radius:8px; font-size:0.85rem; border:1px solid #333;"><strong>[AI ì¶”ì²œ]</strong><br><br>${result}</div>`;
            } catch (e) { aiResults.innerHTML = `<p style="color:#ff4d4d; font-size:0.75rem;">ì˜¤ë¥˜: API í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>`; }
        };

        window.openSearch = () => { switchPanelTab('search'); rightPanel.classList.add('active'); const kw = prompt("ê²€ìƒ‰ì–´:"); if(kw) runSearch(kw); };
        function runSearch(keyword) {
            searchList.innerHTML = "";
            chaptersData.filter(c => (c.content || "").includes(keyword)).forEach(res => {
                const item = document.createElement('div');
                item.className = 'search-res-item';
                item.innerHTML = `<div class="search-res-title">${res.title}</div><div style="font-size:0.75rem; color:#666;">ë‚´ìš© í¬í•¨ë¨</div>`;
                item.onclick = () => { loadChapter(res.id); closePanels(); };
                searchList.appendChild(item);
            });
        }

        // ê³µí†µ ìœ í‹¸ë¦¬í‹°
        window.toggleFolder = (id) => { currentFolderId = (currentFolderId === id) ? 'none' : id; localStorage.setItem('lastFolderId', currentFolderId); renderAll(); };
        async function loadChapter(id) {
            if(isTyping) return; currentChapterId = id; localStorage.setItem('lastChapterId', id);
            const snap = await getDoc(doc(db, "myNovels", id));
            if (snap.exists()) {
                const data = snap.data(); titleInput.value = data.title; editor.innerHTML = data.content;
                lastSavedContent = data.content; updateWordCount(); renderAll();
            }
        }
        let saveTimer;
        const processSave = (type) => {
            isTyping = true; syncStatus.style.color = "#ff4d4d";
            clearTimeout(saveTimer);
            saveTimer = setTimeout(async () => {
                if(type === 'world') await setDoc(doc(db, "app_settings", "world_memo"), { content: worldMemo.value });
                else await setDoc(doc(db, "myNovels", currentChapterId), { title: titleInput.value, content: editor.innerHTML, updatedAt: Date.now() }, { merge: true });
                syncStatus.style.color = "#4ade80"; isTyping = false;
            }, 1000);
        };
        window.switchTab = (type) => {
            document.getElementById('tab-epi').classList.toggle('active', type === 'epi');
            document.getElementById('tab-world').classList.toggle('active', type === 'world');
            document.getElementById('content-epi').classList.toggle('hidden', type !== 'epi');
            document.getElementById('content-world').classList.toggle('hidden', type !== 'world');
        };
        window.switchPanelTab = (type) => {
            document.getElementById('p-tab-search').classList.toggle('active', type === 'search');
            document.getElementById('p-tab-ai').classList.toggle('active', type === 'ai');
            document.getElementById('p-content-search').classList.toggle('hidden', type !== 'search');
            document.getElementById('p-content-ai').classList.toggle('hidden', type !== 'ai');
        };
        window.closePanels = () => { rightPanel.classList.remove('active'); aiPopup.style.display = 'none'; };
        titleInput.addEventListener('input', () => processSave('epi'));
        editor.addEventListener('input', () => { processSave('epi'); updateWordCount(); });
        worldMemo.addEventListener('input', () => processSave('world'));
        window.addNewFolder = async () => { const n = prompt("ìƒˆ í´ë”:"); if(n) await setDoc(doc(db, "folders", 'fd'+Date.now()), { name: n, createdAt: Date.now() }); };
        window.addNewChapter = async () => { if(currentFolderId === 'none') return alert("í´ë” ì„ íƒ!"); const id = 'ch'+Date.now(); await setDoc(doc(db, "myNovels", id), { title: "ìƒˆ ì—í”¼ì†Œë“œ", content: "", folderId: currentFolderId, order: 9999, createdAt: Date.now() }); loadChapter(id); };
        window.deleteChapter = async (id, e) => { e.stopPropagation(); if(confirm("ì‚­ì œ?")) await deleteDoc(doc(db, "myNovels", id)); };
        window.copyAllText = () => { navigator.clipboard.writeText(editor.innerText).then(() => alert("ë³µì‚¬ë¨!")); };
        window.updateWordCount = () => { const cnt = (editor.innerText || "").length; document.getElementById('word-count').innerText = cnt.toLocaleString() + 'ì'; };
    </script>
</body>
</html>