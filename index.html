<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cloud Studio v5.9</title>
    <style>
        :root { --font-size: 1.15rem; --paragraph-margin: 10px; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: #1a1a1a; color: #d4d4d4; font-family: 'Pretendard', -apple-system, sans-serif; overflow: hidden; }
        .app-container { display: flex; width: 100vw; height: 100vh; overflow: hidden; }
        
        /* ì ê¸ˆ í™”ë©´ */
        #lock-screen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #111; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #lock-screen input { padding: 15px; width: 220px; border-radius: 8px; border: 1px solid #333; background: #222; color: white; font-size: 1.2rem; text-align: center; outline: none; }
        #lock-screen button { margin-top: 15px; padding: 10px 40px; background: #4a90e2; border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 280px; min-width: 280px; height: 100%; background: #111; border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; box-sizing: border-box; z-index: 1000; }
        @media (max-width: 768px) { .sidebar { position: fixed; left: 0; transform: translateX(-100%); transition: 0.3s; } .sidebar.active { transform: translateX(0); } }
        
        .sidebar-header { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
        .sidebar-header h2 { font-size: 0.75rem; color: #444; letter-spacing: 2px; margin: 0; }
        .refresh-btn { cursor: pointer; color: #4a90e2; font-size: 1.2rem; padding: 5px; background: #222; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }

        /* íƒ­ ë©”ë‰´ */
        .tab-menu { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 8px; font-size: 0.7rem; background: none; border: 1px solid #333; color: #555; cursor: pointer; border-radius: 4px; }
        .tab-btn.active { background: #2a2a2a; color: #fff; border-color: #4a90e2; }

        .sidebar-content { flex: 1; overflow-y: auto; overflow-x: hidden; }
        
        /* í´ë” ë° ì—í”¼ì†Œë“œ ë¦¬ìŠ¤íŠ¸ */
        .folder-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 8px; cursor: pointer; color: #bbb; font-weight: bold; font-size: 0.85rem; border-bottom: 1px solid #222; }
        .folder-header.open { color: #4a90e2; }
        .chapter-list { list-style: none; padding: 0; margin: 0; display: block; }
        .chapter-list.collapsed { display: none !important; } /* í™•ì‹¤í•œ ìˆ¨ê¹€ ì²˜ë¦¬ */

        .chapter-item-container { display: flex; justify-content: space-between; align-items: center; border-radius: 4px; margin: 2px 0 2px 10px; border-left: 1px solid #222; }
        .chapter-item-container.active { background: #222; border-left: 3px solid #4a90e2; }
        .chapter-item { flex: 1; padding: 10px; cursor: pointer; font-size: 0.85rem; color: #777; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content { flex: 1; height: 100%; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; align-items: center; padding: 40px 20px 160px 20px; box-sizing: border-box; background: #1a1a1a; position: relative; touch-action: pan-y; }
        .editor-container { width: 100%; max-width: 800px; }
        #chapter-title { width: 100%; font-size: 1.8rem; border: none; background: transparent; color: #fff; outline: none; margin-bottom: 30px; font-weight: bold; }
        #editor { width: 100%; min-height: 60vh; font-size: var(--font-size); line-height: 1.8em; color: #d4d4d4; outline: none; white-space: pre-wrap; word-break: break-all; }

        /* í•˜ë‹¨ ìƒíƒœë°” */
        .status-bar { position: fixed; bottom: 0; left: 280px; right: 0; background: #111; border-top: 1px solid #222; z-index: 998; }
        @media (max-width: 768px) { .status-bar { left: 0; } }
        .status-info { padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; }
        .save-time { color: #333; margin-right: 10px; font-style: italic; white-space: nowrap; }
        
        .menu-toggle { position: fixed; top: 15px; left: 15px; z-index: 2000; background: #222; color: white; border: none; padding: 10px 15px; border-radius: 8px; display: none; }
        @media (max-width: 768px) { .menu-toggle { display: block; } }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h2 style="color:#4a90e2; letter-spacing:4px;">STUDIO LOCK</h2>
        <input type="password" id="pw-input" placeholder="Password" onkeypress="if(event.keyCode==13) checkAuth()">
        <button onclick="checkAuth()">ENTER</button>
    </div>

    <button class="menu-toggle" onclick="toggleSidebar()">â˜° ë©”ë‰´</button>
    
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>CLOUD STUDIO</h2>
                <div class="refresh-btn" onclick="manualSync()">â†»</div>
            </div>
            <div class="tab-menu">
                <button class="tab-btn active" id="tab-epi" onclick="switchTab('epi')">ğŸ“ ì—í”¼ì†Œë“œ</button>
                <button class="tab-btn" id="tab-world" onclick="switchTab('world')">ğŸŒ ì„¤ì •/ë©”ëª¨</button>
            </div>
            <div id="content-epi" class="sidebar-content">
                <div style="display:flex; gap:8px; margin-bottom:20px;">
                    <button onclick="addNewFolder()" style="flex:1; padding:10px; background:#2a2a2a; border:1px solid #444; color:#fff; border-radius:6px; font-size:0.75rem;">ğŸ“ í´ë”</button>
                    <button onclick="addNewChapter()" style="flex:1; padding:10px; background:#2a2a2a; border:1px solid #444; color:#fff; border-radius:6px; font-size:0.75rem;">ğŸ“ ì—í”¼</button>
                </div>
                <div id="folder-list">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
            <div id="content-world" class="sidebar-content" style="display:none;">
                <textarea id="world-memo-area" style="width:100%; height:85%; background:transparent; border:none; color:#888; font-size:0.85rem; line-height:1.7; outline:none; resize:none; padding:10px; box-sizing:border-box;" placeholder="ì„¸ê³„ê´€ ì„¤ì •ì„ ê¸°ë¡í•˜ì„¸ìš”..."></textarea>
            </div>
        </div>
        <div class="main-content" onclick="closeSidebar()">
            <div class="editor-container">
                <div style="display:flex; gap:8px; margin-bottom:20px; justify-content:flex-end;">
                    <button onclick="copyAllText()" style="background:none; border:1px solid #333; color:#4a90e2; padding:6px 12px; border-radius:4px; font-size:0.75rem; cursor:pointer;">ğŸ“‹ ë³µì‚¬</button>
                    <button onclick="restoreVersion()" style="background:none; border:1px solid #333; color:#888; padding:6px 12px; border-radius:4px; font-size:0.75rem; cursor:pointer;">â³ ë³µêµ¬</button>
                    <button onclick="exportText()" style="background:none; border:1px solid #333; color:#888; padding:6px 12px; border-radius:4px; font-size:0.75rem; cursor:pointer;">ğŸ’¾ TXT</button>
                </div>
                <input type="text" id="chapter-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                <div id="editor" contenteditable="true" spellcheck="true"></div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div id="progress-bar" style="height:3px; background:#4a90e2; width:0%; transition:0.3s;"></div>
        <div class="status-info">
            <div style="color:#888;">
                <span onclick="setGoal()" style="cursor:pointer; text-decoration:underline; margin-right:10px;">ëª©í‘œ:<span id="display-goal">5,000</span></span>
                <span onclick="setFontSize()" style="cursor:pointer; text-decoration:underline;">ê¸€ì:<span id="display-font">1.15</span></span>
            </div>
            <div style="display:flex; align-items:center; gap:5px;">
                <span id="last-save-time" class="save-time">ì—°ê²° ëŒ€ê¸°</span>
                <div id="word-count" style="margin-right:10px;">0ì</div>
                <div id="sync-status" style="font-weight:bold;">â—</div>
                <span style="color:#222; font-weight:bold; margin-left:10px;">v5.9</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, deleteDoc, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”¥ ë³¸ì¸ì˜ ì„¤ì •ì„ ì…ë ¥í•˜ì„¸ìš”
        const firebaseConfig = {
 apiKey: "AIzaSyC4FjTYr8xxPH9y7H13h8EzIf-CxKb8QkI",
  authDomain: "my-typi-app.firebaseapp.com",
  projectId: "my-typi-app",
  storageBucket: "my-typi-app.firebasestorage.app",
  messagingSenderId: "793573516752",
  appId: "1:793573516752:web:2b3d20a8c432a0b5d445d5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const syncStatus = document.getElementById('sync-status');

        let currentChapterId = localStorage.getItem('lastChapterId') || '';
        let currentFolderId = localStorage.getItem('lastFolderId') || 'none';
        let isTyping = false;
        let lastSavedContent = ""; 
        let settings = { goalWords: 5000, fontSize: 1.15, studioPw: "0000" };
        
        let foldersCache = [];
        let chaptersCache = [];

        const editor = document.getElementById('editor');
        const titleInput = document.getElementById('chapter-title');
        const worldMemo = document.getElementById('world-memo-area');

        // --- 1. [ì§„ë‹¨ íŒ¨ì¹˜] ê°•ì œ ë°ì´í„° ë™ê¸°í™” (ìˆ˜ë™/ìë™ í†µí•©) ---
        async function manualSync() {
            try {
                syncStatus.style.color = "#ff4d4d"; // ë™ê¸°í™” ì¤‘ ë¹¨ê°„ìƒ‰
                
                // 1. ì„¤ì • ë° ë©”ëª¨ ë¡œë“œ
                const [sSnap, wSnap] = await Promise.all([
                    getDoc(doc(db, "app_settings", "global_v1")),
                    getDoc(doc(db, "app_settings", "world_memo"))
                ]);
                if(sSnap.exists()) { settings = {...settings, ...sSnap.data()}; applySettings(); }
                if(wSnap.exists()) { worldMemo.value = wSnap.data().content; }

                // 2. í´ë” ë° ì—í”¼ì†Œë“œ ë¡œë“œ (getDocsë¡œ í•œ ë²ˆì— í™•ì‹¤íˆ)
                const [fSnap, cSnap] = await Promise.all([
                    getDocs(query(collection(db, "folders"), orderBy("createdAt", "asc"))),
                    getDocs(query(collection(db, "myNovels"), orderBy("createdAt", "asc")))
                ]);

                foldersCache = []; fSnap.forEach(d => foldersCache.push({id: d.id, ...d.data()}));
                chaptersCache = []; cSnap.forEach(d => chaptersCache.push({id: d.id, ...d.data()}));

                rebuildUI();

                // 3. ì²« ì—í”¼ì†Œë“œ ë¡œë“œ
                if(!currentChapterId && chaptersCache.length > 0) currentChapterId = chaptersCache[0].id;
                if(currentChapterId) loadChapter(currentChapterId);

                syncStatus.style.color = "#4ade80"; // ì™„ë£Œ ì´ˆë¡ìƒ‰
                updateSaveTime();

            } catch (err) {
                alert("ì•„ì´í° ì—°ê²° ì‹¤íŒ¨: " + err.message);
            }
        }

        // --- 2. ë Œë”ë§ ì—”ì§„ (ì•„ì´í° ì‚¬íŒŒë¦¬ í˜¸í™˜ì„± ê°•í™”) ---
        function rebuildUI() {
            const listUI = document.getElementById('folder-list');
            if (!listUI) return;
            listUI.innerHTML = '';
            
            const unclassified = chaptersCache.filter(c => !c.folderId);
            if(unclassified.length > 0) listUI.appendChild(createFolderDOM("ğŸ“‚ ë¯¸ë¶„ë¥˜ ì›ê³ ", "none", unclassified));

            foldersCache.forEach(f => {
                const fChapters = chaptersCache.filter(c => c.folderId === f.id);
                listUI.appendChild(createFolderDOM("ğŸ“‚ " + f.name, f.id, fChapters));
            });
        }

        function createFolderDOM(name, id, chapters) {
            const isOpen = (currentFolderId === id);
            const container = document.createElement('div');
            container.innerHTML = `
                <div class="folder-header ${isOpen ? 'open' : ''}" onclick="toggleFolder('${id}')">
                    <span>${name}</span>
                    <span style="font-size:0.7rem; opacity:0.3;">${chapters.length}</span>
                </div>
                <ul id="list-${id}" class="chapter-list ${isOpen ? '' : 'collapsed'}"></ul>
            `;
            
            const ul = container.querySelector('ul');
            chapters.forEach(c => {
                const li = document.createElement('li');
                li.className = `chapter-item-container ${c.id === currentChapterId ? 'active' : ''}`;
                li.innerHTML = `<div class="chapter-item">${c.title || 'ì œëª© ì—†ìŒ'}</div>`;
                li.onclick = () => { loadChapter(c.id); };
                ul.appendChild(li);
            });
            return container;
        }

        window.toggleFolder = (id) => {
            currentFolderId = (currentFolderId === id) ? 'none' : id;
            localStorage.setItem('lastFolderId', currentFolderId);
            rebuildUI();
        };

        async function loadChapter(id) {
            currentChapterId = id; localStorage.setItem('lastChapterId', id);
            const snap = await getDoc(doc(db, "myNovels", id));
            if (snap.exists()) {
                const data = snap.data();
                titleInput.value = data.title;
                editor.innerHTML = data.content;
                lastSavedContent = data.content;
                updateWordCount();
                if(window.innerWidth <= 768) closeSidebar();
                rebuildUI(); // ì„ íƒ í‘œì‹œ ì—…ë°ì´íŠ¸
            }
        }

        // --- 3. ì €ì¥ ë° ê¸°íƒ€ ê¸°ëŠ¥ ---
        let saveTimeout;
        const processSave = async (source) => {
            if(!currentChapterId && source !== 'world') return;
            isTyping = true; syncStatus.style.color = "#ff4d4d";
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                try {
                    if(source === 'world') { await setDoc(doc(db, "app_settings", "world_memo"), { content: worldMemo.value }); }
                    else {
                        let finalTitle = titleInput.value;
                        if(source === 'editor') {
                            const bolds = editor.querySelectorAll('b, strong');
                            if(bolds.length > 0) { finalTitle = bolds[bolds.length - 1].innerText.trim(); titleInput.value = finalTitle; }
                        }
                        await setDoc(doc(db, "myNovels", currentChapterId), { title: finalTitle, content: editor.innerHTML, updatedAt: Date.now() }, { merge: true });
                        lastSavedContent = editor.innerHTML;
                    }
                    syncStatus.style.color = "#4ade80"; updateSaveTime(); isTyping = false;
                } catch (e) { syncStatus.style.color = "#333"; }
            }, 1000);
        };

        window.checkAuth = () => {
            if(document.getElementById('pw-input').value === settings.studioPw) {
                document.getElementById('lock-screen').style.display = 'none';
                sessionStorage.setItem('isStudioAuth', 'true');
                manualSync(); // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì¦‰ì‹œ ë™ê¸°í™”
            } else { alert("Wrong password"); }
        };
        if(sessionStorage.getItem('isStudioAuth') === 'true') {
            document.getElementById('lock-screen').style.display = 'none';
            manualSync();
        }

        // ìœ í‹¸ë¦¬í‹°
        function updateSaveTime() {
            const n = new Date();
            document.getElementById('last-save-time').innerText = `ìµœê·¼: ${n.getFullYear()}/${(n.getMonth()+1)}/${n.getDate()} ${n.getHours()}:${n.getMinutes().toString().padStart(2,'0')}`;
        }
        function applySettings() {
            document.documentElement.style.setProperty('--font-size', settings.fontSize + 'rem');
            document.getElementById('display-goal').innerText = parseInt(settings.goalWords).toLocaleString();
            document.getElementById('display-font').innerText = settings.fontSize;
            updateWordCount();
        }
        window.switchTab = (t) => {
            document.getElementById('tab-epi').classList.toggle('active', t === 'epi');
            document.getElementById('tab-world').classList.toggle('active', t === 'world');
            document.getElementById('content-epi').style.display = (t === 'epi') ? 'block' : 'none';
            document.getElementById('content-world').style.display = (t === 'world') ? 'block' : 'none';
        };
        titleInput.addEventListener('input', () => processSave('title'));
        editor.addEventListener('input', () => { processSave('editor'); updateWordCount(); });
        worldMemo.addEventListener('input', () => processSave('world'));
        window.addNewFolder = async () => { const n = prompt("ìƒˆ í´ë”:"); if(n) await setDoc(doc(db, "folders", 'fd'+Date.now()), { name: n, createdAt: Date.now() }); manualSync(); };
        window.addNewChapter = async () => { if(currentFolderId === 'none') return alert("í´ë” ì„ íƒ!"); const id = 'ch'+Date.now(); await setDoc(doc(db, "myNovels", id), { title: "ìƒˆ ì—í”¼ì†Œë“œ", content: "", folderId: currentFolderId, createdAt: Date.now() }); manualSync(); loadChapter(id); };
        window.restoreVersion = () => { if(confirm("ë³µêµ¬?")) { editor.innerHTML = lastSavedContent; updateWordCount(); } };
        window.copyAllText = () => { navigator.clipboard.writeText(editor.innerText).then(() => alert("ë³µì‚¬ë¨!")); };
        window.updateWordCount = () => { const cnt = (editor.innerText || "").replace(/\r\n/g, "\n").trim().length; document.getElementById('word-count').innerText = cnt.toLocaleString() + 'ì'; document.getElementById('progress-bar').style.width = Math.min((cnt / settings.goalWords) * 100, 100) + "%"; };
        window.exportText = () => { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([editor.innerText],{type:'text/plain'})); a.download=`${titleInput.value}.txt`; a.click(); };
        window.changePw = () => { const p = prompt("í˜„ì¬ ì•”í˜¸:"); if(p === settings.studioPw) { const n = prompt("ìƒˆ ì•”í˜¸:"); if(n) setDoc(doc(db, "app_settings", "global_v1"), {...settings, studioPw:n}); } };
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
        window.closeSidebar = () => document.getElementById('sidebar').classList.remove('active');
        applySettings();
    </script>
</body>
</html>