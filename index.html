<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Cloud Novel Studio v3.5</title>
    <style>
        :root { --font-size: 1.15rem; --paragraph-margin: 10px; }
        body { margin: 0; display: flex; background: #1a1a1a; color: #d4d4d4; font-family: 'Pretendard', sans-serif; overflow: hidden; position: fixed; width: 100vw; height: 100vh; }
        
        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: 280px; height: 100vh; background: #111; border-right: 1px solid #333; padding: 20px; display: flex; flex-direction: column; box-sizing: border-box; transition: transform 0.3s ease; z-index: 1000; }
        @media (max-width: 768px) { .sidebar { position: fixed; left: 0; top: 0; transform: translateX(-100%); } .sidebar.active { transform: translateX(0); } }

        .sidebar h2 { font-size: 0.7rem; color: #444; letter-spacing: 2px; margin-bottom: 20px; text-align: center; }
        .sidebar-btns { display: flex; gap: 8px; margin-bottom: 20px; }
        .add-btn { flex: 1; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: #fff; cursor: pointer; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }

        /* í´ë” ë° ì—í”¼ì†Œë“œ */
        .folder-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; }
        .folder-container { margin-bottom: 10px; }
        .folder-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 10px; background: #1a1a1a; border-radius: 6px; cursor: pointer; color: #bbb; font-weight: bold; font-size: 0.85rem; }
        .chapter-list { list-style: none; padding-left: 15px; margin-top: 5px; }
        .chapter-list.hidden { display: none; }
        .chapter-item-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; border-radius: 4px; }
        .chapter-item-container.active { background: #222; border-left: 3px solid #4a90e2; }
        .chapter-item { flex: 1; padding: 8px 10px; cursor: pointer; font-size: 0.8rem; color: #777; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .chapter-item-container.active .chapter-item { color: #fff; }
        .del-icon { padding: 0 8px; color: #333; cursor: pointer; font-size: 0.8rem; }

        /* ë©”ì¸ ì˜ì—­ */
        .main-content { flex: 1; height: 100vh; overflow-y: scroll; -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; align-items: center; padding: 40px 20px 150px 20px; box-sizing: border-box; }
        .editor-container { width: 100%; max-width: 800px; }
        #chapter-title { width: 100%; font-size: 1.6rem; border: none; background: transparent; color: #fff; outline: none; margin-bottom: 30px; font-weight: bold; }
        #editor { width: 100%; min-height: 70vh; border: none; outline: none; font-size: var(--font-size); line-height: 1.6em !important; color: #d4d4d4; white-space: pre-wrap; }
        #editor div, #editor p { margin: var(--paragraph-margin) 0 !important; line-height: 1.6em !important; }

        /* íˆ´ë°” ìƒë‹¨ ë²„íŠ¼ë“¤ */
        .toolbar { display: flex; gap: 8px; margin-bottom: 20px; justify-content: flex-end; flex-wrap: wrap; }
        .tool-btn { background: #222; border: 1px solid #333; color: #888; padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: 0.2s; }
        .tool-btn:hover { background: #333; color: #fff; border-color: #555; }
        .copy-btn { color: #4a90e2; border-color: #4a90e2; } /* ë³µì‚¬ ë²„íŠ¼ ê°•ì¡° */

        /* í•˜ë‹¨ ì •ë³´ë°” */
        .status-bar { position: fixed; bottom: 0; left: 280px; right: 0; background: #111; border-top: 1px solid #222; z-index: 900; }
        @media (max-width: 768px) { .status-bar { left: 0; } }
        .progress-container { height: 4px; background: #222; width: 100%; }
        #progress-bar { height: 100%; background: #4a90e2; width: 0%; transition: 0.3s; }
        .status-info { padding: 10px 25px; display: flex; justify-content: space-between; font-size: 0.7rem; color: #555; align-items: center; }
        .setting-group { display: flex; gap: 12px; }
        .setting-link { cursor: pointer; text-decoration: underline; text-underline-offset: 3px; }
        
        .menu-toggle { position: fixed; top: 15px; left: 15px; z-index: 2000; background: #222; color: white; border: none; padding: 10px 15px; border-radius: 8px; display: none; }
        @media (max-width: 768px) { .menu-toggle { display: block; } }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleSidebar()">â˜° ë©”ë‰´</button>

    <div class="sidebar" id="sidebar">
        <h2>CLOUD STUDIO</h2>
        <div class="sidebar-btns">
            <button class="add-btn" onclick="addNewFolder()">ğŸ“ ìƒˆ ì‘í’ˆ</button>
            <button class="add-btn" onclick="addNewChapter()">ğŸ“ ì—í”¼ì†Œë“œ</button>
        </div>
        <div class="folder-list" id="folder-list"></div>
    </div>

    <div class="main-content" onclick="closeSidebar()">
        <div class="editor-container">
            <div class="toolbar">
                <button class="tool-btn copy-btn" onclick="copyAllText()">ğŸ“‹ ì „ì²´ë³µì‚¬</button>
                <button class="tool-btn" onclick="restoreVersion()">â³ ë³µêµ¬</button>
                <button class="tool-btn" onclick="exportText()">ğŸ’¾ TXT</button>
            </div>
            <input type="text" id="chapter-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            <div id="editor" contenteditable="true" spellcheck="true"></div>
        </div>
    </div>

    <div class="status-bar">
        <div class="progress-container"><div id="progress-bar"></div></div>
        <div class="status-info">
            <div class="setting-group">
                <span class="setting-link" onclick="setGoal()">ëª©í‘œ: <span id="display-goal">5,000</span></span>
                <span class="setting-link" onclick="setFontSize()">ê¸€ì: <span id="display-font">1.15</span></span>
                <span class="setting-link" onclick="setMargin()">ë¬¸ë‹¨: <span id="display-margin">10</span></span>
            </div>
            <div id="word-count">0ì</div>
            <div id="sync-status">ì—°ê²°ë¨</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { /* ì—¬ê¸°ì— Firebase ì„¤ì •ì„ ì…ë ¥í•˜ì„¸ìš” */ 
  authDomain: "my-typi-app.firebaseapp.com",
  projectId: "my-typi-app",
  storageBucket: "my-typi-app.firebasestorage.app",
  messagingSenderId: "793573516752",
  appId: "1:793573516752:web:2b3d20a8c432a0b5d445d5"

};
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentChapterId = '';
        let currentFolderId = localStorage.getItem('lastFolderId') || '';
        let goalWords = localStorage.getItem('novelGoalWords') || 5000;
        let fontSize = localStorage.getItem('novelFontSize') || 1.15;
        let paragraphMargin = localStorage.getItem('novelMargin') || 10;
        let lastSavedContent = "";

        const editor = document.getElementById('editor');
        const titleInput = document.getElementById('chapter-title');
        const sidebar = document.getElementById('sidebar');

        function applySettings() {
            document.documentElement.style.setProperty('--font-size', fontSize + 'rem');
            document.documentElement.style.setProperty('--paragraph-margin', paragraphMargin + 'px');
            document.getElementById('display-goal').innerText = parseInt(goalWords).toLocaleString();
            document.getElementById('display-font').innerText = fontSize;
            document.getElementById('display-margin').innerText = paragraphMargin;
            updateWordCount();
        }

        // ì „ì²´ ë³µì‚¬ ê¸°ëŠ¥ ì¶”ê°€
        window.copyAllText = () => {
            const text = editor.innerText;
            if (!text) { alert("ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.innerText;
                btn.innerText = "âœ”ï¸ ë³µì‚¬ì™„ë£Œ!";
                btn.style.color = "#4ade80";
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.color = "#4a90e2";
                }, 2000);
            }).catch(err => {
                alert("ë³µì‚¬ ì‹¤íŒ¨: " + err);
            });
        };

        window.addNewFolder = async () => {
            const name = prompt("ìƒˆ ì‘í’ˆ(í´ë”) ì´ë¦„:");
            if (!name) return;
            const id = 'fd' + Date.now();
            await setDoc(doc(db, "folders", id), { name, createdAt: Date.now() });
            currentFolderId = id;
            localStorage.setItem('lastFolderId', id);
        };

        window.addNewChapter = async () => {
            if (!currentFolderId) { alert("ì‘í’ˆì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            const id = 'ch' + Date.now();
            await setDoc(doc(db, "myNovels", id), { title: "ìƒˆ ì—í”¼ì†Œë“œ", content: "", folderId: currentFolderId, createdAt: Date.now() });
            loadChapter(id);
        };

        onSnapshot(query(collection(db, "folders"), orderBy("createdAt", "desc")), (fSnap) => {
            onSnapshot(query(collection(db, "myNovels"), orderBy("createdAt", "asc")), (cSnap) => {
                const listUI = document.getElementById('folder-list');
                listUI.innerHTML = '';
                fSnap.forEach((fDoc) => {
                    const fId = fDoc.id;
                    const folderDiv = document.createElement('div');
                    folderDiv.className = 'folder-container';
                    folderDiv.innerHTML = `<div class="folder-header" onclick="toggleFolder('${fId}')">
                        <span>ğŸ“‚ ${fDoc.data().name}</span>
                        <span class="del-icon" onclick="deleteFolder('${fId}', event)">Ã—</span>
                    </div>
                    <ul id="list-${fId}" class="chapter-list ${currentFolderId !== fId ? 'hidden' : ''}"></ul>`;
                    
                    const cListUI = folderDiv.querySelector('ul');
                    cSnap.forEach((cDoc) => {
                        if (cDoc.data().folderId === fId) {
                            const li = document.createElement('li');
                            li.className = `chapter-item-container ${cDoc.id === currentChapterId ? 'active' : ''}`;
                            li.innerHTML = `<div class="chapter-item">${cDoc.data().title}</div>
                                            <div class="del-icon" onclick="deleteChapter('${cDoc.id}', event)">Ã—</div>`;
                            li.onclick = () => loadChapter(cDoc.id);
                            cListUI.appendChild(li);
                        }
                    });
                    listUI.appendChild(folderDiv);
                });
            });
        });

        window.toggleFolder = (id) => {
            currentFolderId = id;
            localStorage.setItem('lastFolderId', id);
            document.querySelectorAll('.chapter-list').forEach(el => el.classList.add('hidden'));
            document.getElementById('list-' + id).classList.remove('hidden');
        };

        async function loadChapter(id) {
            currentChapterId = id;
            const snap = await getDoc(doc(db, "myNovels", id));
            if (snap.exists()) {
                titleInput.value = snap.data().title;
                editor.innerHTML = snap.data().content;
                lastSavedContent = snap.data().content;
                updateWordCount();
            }
        }

        window.deleteFolder = async (id, e) => { e.stopPropagation(); if(confirm("í´ë”ë¥¼ ì‚­ì œí• ê¹Œìš”?")) await deleteDoc(doc(db, "folders", id)); };
        window.deleteChapter = async (id, e) => { e.stopPropagation(); if(confirm("ì‚­ì œí• ê¹Œìš”?")) await deleteDoc(doc(db, "myNovels", id)); };

        let saveTimeout;
        const autoSave = () => {
            if(!currentChapterId) return;
            syncStatus.innerText = "â˜ï¸ ì €ì¥ ì¤‘...";
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                try {
                    await setDoc(doc(db, "myNovels", currentChapterId), { title: titleInput.value, content: editor.innerHTML, updatedAt: Date.now() }, { merge: true });
                    syncStatus.innerText = "â˜ï¸ ì €ì¥ë¨"; updateWordCount();
                } catch (e) { syncStatus.innerText = "âŒ ì‹¤íŒ¨"; }
            }, 800);
        };

        function updateWordCount() {
            const count = editor.innerText.length;
            const percent = Math.min((count / goalWords) * 100, 100);
            document.getElementById('word-count').innerText = `${count.toLocaleString()}ì`;
            document.getElementById('progress-bar').style.width = percent + "%";
        }

        window.setGoal = () => { const val = prompt("ëª©í‘œ:", goalWords); if(val){ goalWords=val; localStorage.setItem('novelGoalWords', val); applySettings(); } };
        window.setFontSize = () => { const val = prompt("í¬ê¸°:", fontSize); if(val){ fontSize=val; localStorage.setItem('novelFontSize', val); applySettings(); } };
        window.setMargin = () => { const val = prompt("ì—¬ë°±:", paragraphMargin); if(val){ paragraphMargin=val; localStorage.setItem('novelMargin', val); applySettings(); } };
        window.restoreVersion = () => { if(confirm("ë³µêµ¬í• ê¹Œìš”?")) { editor.innerHTML = lastSavedContent; updateWordCount(); } };
        window.exportText = () => { const blob = new Blob([editor.innerText], {type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`${titleInput.value}.txt`; a.click(); };

        editor.addEventListener('input', autoSave);
        titleInput.addEventListener('input', autoSave);
        applySettings();
    </script>
</body>
</html>
