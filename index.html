<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cloud Studio v5.0</title>
    <style>
        :root { --font-size: 1.15rem; --paragraph-margin: 10px; }

        /* 1. PC/ì•„ì´í° í†µí•© ë ˆì´ì•„ì›ƒ (í”ë“¤ë¦¼ ë°©ì§€ + í™”ë©´ ê½‰ ì±„ì›€) */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #1a1a1a; color: #d4d4d4;
            font-family: 'Pretendard', -apple-system, sans-serif;
            overflow: hidden; 
        }
        
        .app-container {
            display: flex; width: 100vw; height: 100vh; overflow: hidden;
        }

        /* 2. ë¹„ë°€ë²ˆí˜¸ ì ê¸ˆ í™”ë©´ */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #111; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        #lock-screen input {
            padding: 15px; width: 220px; border-radius: 8px; border: 1px solid #333;
            background: #222; color: white; font-size: 1.2rem; text-align: center; outline: none;
        }
        #lock-screen button {
            margin-top: 15px; padding: 10px 40px; background: #4a90e2; border: none;
            color: white; border-radius: 6px; cursor: pointer; font-weight: bold;
        }

        /* 3. ì‚¬ì´ë“œë°” (PC ê³ ì •, ëª¨ë°”ì¼ ìŠ¬ë¼ì´ë“œ) */
        .sidebar { 
            width: 280px; min-width: 280px; height: 100%; background: #111; 
            border-right: 1px solid #333; padding: 20px; display: flex; 
            flex-direction: column; box-sizing: border-box; z-index: 1000;
        }
        @media (max-width: 768px) { 
            .sidebar { position: fixed; left: 0; transform: translateX(-100%); transition: 0.3s; } 
            .sidebar.active { transform: translateX(0); } 
        }
        .sidebar-btns { display: flex; gap: 8px; margin-bottom: 20px; }
        .add-btn { flex: 1; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: #fff; border-radius: 6px; font-size: 0.75rem; font-weight: bold; cursor: pointer; }

        /* 4. ë©”ì¸ ì›ê³  ì˜ì—­ */
        .main-content {
            flex: 1; height: 100%; overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch; display: flex; flex-direction: column; 
            align-items: center; padding: 40px 20px 160px 20px; box-sizing: border-box;
            background: #1a1a1a; position: relative; touch-action: pan-y;
        }
        .editor-container { width: 100%; max-width: 800px; }

        #chapter-title { 
            width: 100%; font-size: 1.8rem; border: none; background: transparent; 
            color: #fff; outline: none; margin-bottom: 30px; font-weight: bold; 
        }
        #editor { 
            width: 100%; min-height: 70vh; font-size: var(--font-size); 
            line-height: 1.8em; color: #d4d4d4; outline: none; white-space: pre-wrap; word-break: break-all;
        }

        /* 5. íˆ´ë°” ë° ìƒíƒœë°” */
        .toolbar { display: flex; gap: 8px; margin-bottom: 20px; justify-content: flex-end; }
        .tool-btn { background: none; border: 1px solid #333; padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
        
        .status-bar { 
            position: fixed; bottom: 0; left: 280px; right: 0; 
            background: #111; border-top: 1px solid #222; z-index: 998; 
        }
        @media (max-width: 768px) { .status-bar { left: 0; } }
        .status-info { padding: 12px 25px; display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; }
        .setting-link { cursor: pointer; text-decoration: underline; margin-right: 10px; color: #888; }
        
        .menu-toggle { position: fixed; top: 15px; left: 15px; z-index: 2000; background: #222; color: white; border: none; padding: 10px 15px; border-radius: 8px; display: none; }
        @media (max-width: 768px) { .menu-toggle { display: block; } }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h2 style="color:#4a90e2; letter-spacing:4px;">STUDIO LOCK</h2>
        <input type="password" id="pw-input" placeholder="Password" onkeypress="if(event.keyCode==13) checkAuth()">
        <button onclick="checkAuth()">ENTER</button>
    </div>

    <button class="menu-toggle" onclick="toggleSidebar()">â˜° ë©”ë‰´</button>
    
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <h2 onclick="location.reload()" style="cursor:pointer; font-size:0.7rem; color:#444; text-align:center; letter-spacing:2px; margin-bottom:20px;">CLOUD STUDIO</h2>
            <div class="sidebar-btns">
                <button class="add-btn" onclick="addNewFolder()">ğŸ“ í´ë”</button>
                <button class="add-btn" onclick="addNewChapter()">ğŸ“ ì—í”¼</button>
            </div>
            <div id="folder-list" style="flex:1; overflow-y:auto;"></div>
        </div>

        <div class="main-content" onclick="closeSidebar()">
            <div class="editor-container">
                <div class="toolbar">
                    <button class="tool-btn" style="color:#4a90e2; border-color:#4a90e2;" onclick="copyAllText()">ğŸ“‹ ë³µì‚¬</button>
                    <button class="tool-btn" style="color:#888;" onclick="restoreVersion()">â³ ë³µêµ¬</button>
                    <button class="tool-btn" style="color:#888;" onclick="exportText()">ğŸ’¾ TXT</button>
                </div>
                <input type="text" id="chapter-title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                <div id="editor" contenteditable="true" spellcheck="true"></div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div id="progress-bar" style="height:3px; background:#4a90e2; width:0%; transition:0.3s;"></div>
        <div class="status-info">
            <div>
                <span class="setting-link" onclick="setGoal()">ëª©í‘œ:<span id="display-goal">5,000</span></span>
                <span class="setting-link" onclick="setFontSize()">ê¸€ì:<span id="display-font">1.15</span></span>
                <span class="setting-link" onclick="changePw()">[ì•”í˜¸ë³€ê²½]</span>
            </div>
            <div style="display:flex; align-items:center; gap:15px;">
                <div id="word-count">0ì</div>
                <div id="sync-status" style="font-weight:bold;">ì—°ê²° ì¤‘...</div>
                <span style="color:#333; font-weight:bold;">v5.0</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ğŸ”¥ ë³¸ì¸ì˜ ì„¤ì •ì„ ì…ë ¥í•˜ì„¸ìš”
        const firebaseConfig = {
          apiKey: "AIzaSyC4FjTYr8xxPH9y7H13h8EzIf-CxKb8QkI",
  authDomain: "my-typi-app.firebaseapp.com",
  projectId: "my-typi-app",
  storageBucket: "my-typi-app.firebasestorage.app",
  messagingSenderId: "793573516752",
  appId: "1:793573516752:web:2b3d20a8c432a0b5d445d5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const syncStatus = document.getElementById('sync-status');

        let currentChapterId = localStorage.getItem('lastChapterId') || '';
        let currentFolderId = localStorage.getItem('lastFolderId') || 'none';
        let lastSavedContent = ""; 
        let isTyping = false;
        let settings = { goalWords: 5000, fontSize: 1.15, studioPw: "0000" };

        const editor = document.getElementById('editor');
        const titleInput = document.getElementById('chapter-title');

        // 1. ì•”í˜¸ ë° ì„¤ì • ë™ê¸°í™”
        onSnapshot(doc(db, "app_settings", "global_v1"), (sDoc) => {
            if (sDoc.exists()) { settings = { ...settings, ...sDoc.data() }; applySettings(); }
            else { setDoc(doc(db, "app_settings", "global_v1"), settings); }
        });

        window.checkAuth = () => {
            if(document.getElementById('pw-input').value === settings.studioPw) {
                document.getElementById('lock-screen').style.display = 'none';
                sessionStorage.setItem('isStudioAuth', 'true');
            } else { alert("Wrong password"); }
        };
        if(sessionStorage.getItem('isStudioAuth') === 'true') document.getElementById('lock-screen').style.display = 'none';

        function applySettings() {
            document.documentElement.style.setProperty('--font-size', settings.fontSize + 'rem');
            document.getElementById('display-goal').innerText = parseInt(settings.goalWords).toLocaleString();
            document.getElementById('display-font').innerText = settings.fontSize;
            updateWordCount();
        }

        // 2. ë°ì´í„° ì—°ë™ (asc ìƒì„±ìˆœ)
        onSnapshot(query(collection(db, "folders"), orderBy("createdAt", "asc")), (fSnap) => {
            onSnapshot(query(collection(db, "myNovels"), orderBy("createdAt", "asc")), (cSnap) => {
                syncStatus.innerText = "â˜ï¸ ì‹¤ì‹œê°„ ì—°ë™ë¨";
                syncStatus.style.color = "#4ade80";
                
                const chapters = [];
                cSnap.forEach(d => chapters.push({id: d.id, ...d.data()}));

                const listUI = document.getElementById('folder-list');
                listUI.innerHTML = '';
                
                const unclassified = chapters.filter(c => !c.folderId);
                if(unclassified.length > 0) listUI.appendChild(renderFolderUI("ğŸ“‚ ë¯¸ë¶„ë¥˜ ì›ê³ ", "none", unclassified));

                fSnap.forEach(fDoc => {
                    const folderChapters = chapters.filter(c => c.folderId === fDoc.id);
                    listUI.appendChild(renderFolderUI("ğŸ“‚ " + fDoc.data().name, fDoc.id, folderChapters));
                });

                if(!isTyping) {
                    const targetId = currentChapterId || (chapters.length > 0 ? chapters[0].id : null);
                    if(targetId && (editor.innerHTML === "" || targetId !== currentChapterId)) {
                        loadChapter(targetId);
                    }
                }
            });
        });

        function renderFolderUI(name, id, chapters) {
            const div = document.createElement('div');
            div.innerHTML = `<div style="padding:10px; color:#bbb; font-weight:bold; cursor:pointer; font-size:0.85rem;" onclick="toggleFolder('${id}')">${name}</div>
            <ul id="list-${id}" style="list-style:none; padding:0; ${currentFolderId !== id ? 'display:none' : ''}"></ul>`;
            const ul = div.querySelector('ul');
            chapters.forEach(c => {
                const li = document.createElement('li');
                li.style.padding = "10px 15px";
                li.style.color = c.id === currentChapterId ? "#fff" : "#777";
                li.style.background = c.id === currentChapterId ? "#222" : "transparent";
                li.style.borderLeft = c.id === currentChapterId ? "3px solid #4a90e2" : "none";
                li.style.cursor = "pointer"; li.style.fontSize = "0.85rem";
                li.innerHTML = `<div style="display:flex; justify-content:space-between;"><span>${c.title || 'ì œëª© ì—†ìŒ'}</span><span onclick="deleteChapter('${c.id}', event)" style="color:#333;">Ã—</span></div>`;
                li.onclick = () => loadChapter(c.id);
                ul.appendChild(li);
            });
            return div;
        }

        async function loadChapter(id) {
            if(isTyping) return;
            currentChapterId = id;
            localStorage.setItem('lastChapterId', id);
            const snap = await getDoc(doc(db, "myNovels", id));
            if (snap.exists()) {
                const data = snap.data();
                titleInput.value = data.title;
                editor.innerHTML = data.content;
                lastSavedContent = data.content; // ë³µêµ¬ë¥¼ ìœ„í•œ ì €ì¥
                updateWordCount();
                if(window.innerWidth <= 768) closeSidebar();
            }
        }

        // 3. ìë™ ì €ì¥ ë° ë³µêµ¬ ë¡œì§
        let saveTimeout;
        editor.addEventListener('input', () => {
            isTyping = true;
            syncStatus.innerText = "â˜ï¸ ì €ì¥ ì¤‘...";
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                const bolds = editor.querySelectorAll('b, strong');
                let autoTitle = titleInput.value;
                if(bolds.length > 0) autoTitle = bolds[bolds.length - 1].innerText.trim();
                
                await setDoc(doc(db, "myNovels", currentChapterId), { 
                    title: autoTitle, content: editor.innerHTML, updatedAt: Date.now() 
                }, { merge: true });
                
                lastSavedContent = editor.innerHTML; // ì €ì¥ëœ ì‹œì ì˜ ë‚´ìš©ì„ ë³µêµ¬ìš©ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                syncStatus.innerText = "â˜ï¸ ì €ì¥ë¨";
                isTyping = false;
            }, 1000);
            updateWordCount();
        });

        window.restoreVersion = () => {
            if(confirm("ë§ˆì§€ë§‰ ì €ì¥ ì‹œì ìœ¼ë¡œ ì›ê³ ë¥¼ ë³µêµ¬í• ê¹Œìš”?")) {
                editor.innerHTML = lastSavedContent;
                updateWordCount();
                alert("ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        };

        // 4. ê¸°íƒ€ ê´€ë¦¬ ê¸°ëŠ¥
        window.addNewFolder = async () => {
            const name = prompt("ìƒˆ í´ë” ì´ë¦„:"); if(!name) return;
            const id = 'fd' + Date.now();
            await setDoc(doc(db, "folders", id), { name, createdAt: Date.now() });
            currentFolderId = id;
        };
        window.addNewChapter = async () => {
            if(!currentFolderId || currentFolderId === 'none') return alert("í´ë”ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
            const id = 'ch' + Date.now();
            await setDoc(doc(db, "myNovels", id), { title: "ìƒˆ ì—í”¼ì†Œë“œ", content: "", folderId: currentFolderId, createdAt: Date.now() });
            loadChapter(id);
        };
        window.toggleFolder = (id) => { currentFolderId = id; localStorage.setItem('lastFolderId', id); location.reload(); };
        window.deleteChapter = async (id, e) => { e.stopPropagation(); if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) await deleteDoc(doc(db, "myNovels", id)); };
        window.copyAllText = () => { navigator.clipboard.writeText(editor.innerText).then(() => alert("ë³µì‚¬ë¨!")); };
        window.updateWordCount = () => {
            const cnt = (editor.innerText || "").replace(/\r\n/g, "\n").trim().length;
            document.getElementById('word-count').innerText = cnt.toLocaleString() + 'ì';
            document.getElementById('progress-bar').style.width = Math.min((cnt / settings.goalWords) * 100, 100) + "%";
        };
        window.exportText = () => { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([editor.innerText],{type:'text/plain'})); a.download=`${titleInput.value}.txt`; a.click(); };
        window.changePw = () => { const p = prompt("í˜„ì¬ ì•”í˜¸:"); if(p === settings.studioPw) { const n = prompt("ìƒˆ ì•”í˜¸:"); if(n) setDoc(doc(db, "app_settings", "global_v1"), {...settings, studioPw:n}); } };
        window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('active');
        window.closeSidebar = () => document.getElementById('sidebar').classList.remove('active');

        applySettings();
    </script>
</body>
</html>